<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Elm Planner</title>
  <script type="text/javascript" src="elm.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>
</body>

<script type="text/javascript">

var startingState = localStorage.getItem("elm-planner-state") || "";

var elmPlanner = Elm.fullscreen(Elm.TreePlanner, {
  fileUpload : "",
  getStorage : startingState
});

elmPlanner.ports.focus.subscribe(function(selector) {
    setTimeout(function() {

      if(selector === "default") {
        document.activeElement.blur();
      } else {
        var nodes = document.querySelectorAll(selector);
        if (nodes.length === 1 && document.activeElement !== nodes[0]) {
            nodes[0].focus();
            if(selector.substring(0,5) === "#node" || selector.substring(0,16) === "#title-bar-input") nodes[0].select();
        }
      }
    }, 20);
});

elmPlanner.ports.save.subscribe(function(saveState) {
  var pom = document.createElement('a');
  pom.setAttribute('href', 'data:text/json;charset=utf-8,' + encodeURIComponent(saveState[1]));
  pom.setAttribute('download', saveState[0].trim() + ".elmplanner");

  pom.style.display = 'none';
  document.body.appendChild(pom);

  pom.click();

  document.body.removeChild(pom);
});

var loadButton = null;
var treePane = null;

function scrollToSelection(selector) {
  var elem;
  if(!selector) 
    elem = document.getElementsByClassName("selected-focused")[0] || document.getElementsByClassName("selected-unfocused")[0];
  if(document.querySelectorAll(selector)[0] || elem)
    (document.querySelectorAll(selector)[0] || elem).scrollIntoViewIfNeeded();
  else setTimeout(scrollToSelection, 10); 
}

function linkUpUI() {
  loadButton = document.getElementById("loadButton");
  treePane = document.getElementsByClassName("tree-pane")[0];
  if(!loadButton || !treePane) {
    setTimeout(linkUpUI, 50);
  } else {
    loadButton.addEventListener("change", function() {
      var reader = new FileReader();
      reader.onload = function(e) {
        elmPlanner.ports.fileUpload.send(e.target.result.trim());
      };
      reader.readAsText(loadButton.files[0]);
    });

    Element.prototype.scrollIntoViewIfNeeded = function (centerIfNeeded) {
      centerIfNeeded = arguments.length === 0 ? true : !!centerIfNeeded;
   
      var parent = treePane,
          parentComputedStyle = window.getComputedStyle(parent, null),
          parentBorderTopWidth = parseInt(parentComputedStyle.getPropertyValue('border-top-width')),
          parentBorderLeftWidth = parseInt(parentComputedStyle.getPropertyValue('border-left-width')),
          overTop = this.offsetTop - parent.offsetTop < parent.scrollTop,
          overBottom = (this.offsetTop - parent.offsetTop + this.clientHeight - parentBorderTopWidth) > (parent.scrollTop + parent.clientHeight),
          overLeft = this.offsetLeft - parent.offsetLeft < parent.scrollLeft + 30,
          overRight = (this.offsetLeft - parent.offsetLeft + this.clientWidth - parentBorderLeftWidth) > (parent.scrollLeft + parent.clientWidth) * 1.4,
          alignWithTop = overTop && !overBottom;
 
      if ((overTop || overBottom) && centerIfNeeded) {
        parent.scrollTop = this.offsetTop - parent.offsetTop - parent.clientHeight / 2 - parentBorderTopWidth + this.clientHeight / 2;
      }
   
      if ((overLeft || overRight) && centerIfNeeded) {
        parent.scrollLeft = (this.offsetLeft - parent.offsetLeft - parent.clientWidth / 2 - parentBorderLeftWidth + this.offsetWidth / 2) - 30;
      }
   
      if ((overTop || overBottom || overLeft || overRight) && !centerIfNeeded) {
        this.scrollIntoView(alignWithTop);
      }
    };
  }
}

linkUpUI();
scrollToSelection();

elmPlanner.ports.setStorage.subscribe(function(stateJSON) {
  localStorage.setItem("elm-planner-state", stateJSON);
});

elmPlanner.ports.log.subscribe(function(str) {
  console.log(str);
});

elmPlanner.ports.scroll.subscribe(function(selector) {
  scrollToSelection(selector);
});

document.onkeydown = function(e) {
  if(!e) var e = window.event;
  var keyCode = e.keyCode || e.which; 
  if ([9,38,40].indexOf(keyCode) > -1) e.preventDefault(); // prevent arrow keys, space, tab
}
</script>

</html>
